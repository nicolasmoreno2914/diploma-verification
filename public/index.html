<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Verificación de Diplomas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="https://inandina.edu.co/wp-content/uploads/2020/11/cropped-logo_inandina-1.png" alt="Institución Educativa Inandina" height="40" class="me-3">
                <div>
                    <div class="brand-title">Sistema de Verificación de Diplomas</div>
                    <div class="brand-subtitle">Consulta Segura y Confiable</div>
                </div>
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <!-- Search Card -->
                <div class="card shadow-lg">
                    <div class="card-header bg-gradient text-white text-center">
                        <h3 class="mb-0">
                            <i class="fas fa-search me-2"></i>
                            Verificar Diploma
                        </h3>
                        <p class="mb-0 mt-2">Ingrese su número de cédula para consultar su diploma</p>
                    </div>
                    <div class="card-body p-4">
                        <form id="verificationForm">
                            <div class="mb-3">
                                <label for="cedula" class="form-label">
                                    <i class="fas fa-id-card me-1"></i>
                                    Número de Cédula o Tarjeta de Identidad
                                </label>
                                <input 
                                    type="text" 
                                    class="form-control form-control-lg" 
                                    id="cedula" 
                                    placeholder="Ej: 12345678"
                                    required
                                    maxlength="15"
                                >
                                <div class="form-text">
                                    Ingrese solo números, sin puntos ni espacios
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary btn-lg w-100" id="searchBtn">
                                <i class="fas fa-search me-2"></i>
                                Buscar Diploma
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Loading Spinner -->
                <div id="loadingSpinner" class="text-center mt-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Buscando...</span>
                    </div>
                    <p class="mt-2">Consultando base de datos...</p>
                </div>

                <!-- Results Card -->
                <div id="resultsCard" class="card shadow-lg mt-4" style="display: none;">
                    <div class="card-header bg-success text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-check-circle me-2"></i>
                            Diploma Encontrado
                        </h4>
                    </div>
                    <div class="card-body">
                        <div id="diplomaInfo"></div>
                    </div>
                </div>

                <!-- Error Card -->
                <div id="errorCard" class="card shadow-lg mt-4" style="display: none;">
                    <div class="card-header bg-danger text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error en la Búsqueda
                        </h4>
                    </div>
                    <div class="card-body">
                        <p id="errorMessage" class="mb-0"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Section -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-body text-center">
                        <h5 class="card-title">Estadísticas del Sistema</h5>
                        <div class="row" id="statsContainer">
                            <div class="col-md-4">
                                <div class="stat-item">
                                    <i class="fas fa-certificate fa-2x text-primary mb-2"></i>
                                    <h4 id="totalDiplomas">-</h4>
                                    <p class="text-muted">Diplomas Registrados</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stat-item">
                                    <i class="fas fa-users fa-2x text-success mb-2"></i>
                                    <h4 id="totalEstudiantes">-</h4>
                                    <p class="text-muted">Estudiantes</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stat-item">
                                    <i class="fas fa-university fa-2x text-info mb-2"></i>
                                    <h4 id="totalInstituciones">-</h4>
                                    <p class="text-muted">Instituciones</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white text-center py-3 mt-5">
        <div class="container">
            <p class="mb-0">
                <i class="fas fa-shield-alt me-1"></i>
                Sistema de Verificación de Diplomas - Consulta Segura y Confiable
            </p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Sistema de Verificación de Diplomas - Solución Embebida Definitiva
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Script embebido cargado correctamente');
            
            // Cargar estadísticas fijas inmediatamente
            document.getElementById('totalDiplomas').textContent = '2,794';
            document.getElementById('totalEstudiantes').textContent = '2,794';
            document.getElementById('totalInstituciones').textContent = '1';
            console.log('Estadísticas cargadas correctamente');
            
            // Elementos del DOM
            const form = document.getElementById('verificationForm');
            const cedulaInput = document.getElementById('cedula');
            const loadingDiv = document.getElementById('loadingSpinner');
            const resultsDiv = document.getElementById('resultsCard');
            const errorDiv = document.getElementById('errorCard');
            const errorMessage = document.getElementById('errorMessage');
            
            // URLs de Google Sheets
            const gvizTecnicosUrl = 'https://docs.google.com/spreadsheets/d/1s4beQ2-EJOwkjKwy_6jvJOtABPjD1104QyxS7kympo0/gviz/tq?tqx=out:csv&gid=1426995834';
            const gvizBachilleresUrl = 'https://docs.google.com/spreadsheets/d/1s4beQ2-EJOwkjKwy_6jvJOtABPjD1104QyxS7kympo0/gviz/tq?tqx=out:csv&gid=0';
            
            // Event listener para el formulario
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const cedula = cedulaInput.value.trim();
                if (cedula) {
                    searchDiploma(cedula);
                }
            });
            
            // Función principal de búsqueda
            async function searchDiploma(cedula) {
                showLoading();
                hideResults();
                hideError();
                
                try {
                    console.log('Buscando cédula:', cedula);
                    
                    // Buscar en técnicos primero
                    const tecnicosResponse = await fetch(gvizTecnicosUrl);
                    const tecnicosText = await tecnicosResponse.text();
                    console.log('Datos técnicos obtenidos, tamaño:', tecnicosText.length);
                    
                    let result = searchDirectInCSV(tecnicosText, cedula, 'Técnico');
                    
                    if (!result) {
                        // Buscar en bachilleres si no se encuentra en técnicos
                        const bachilleresResponse = await fetch(gvizBachilleresUrl);
                        const bachilleresText = await bachilleresResponse.text();
                        console.log('Datos bachilleres obtenidos, tamaño:', bachilleresText.length);
                        
                        result = searchDirectInCSV(bachilleresText, cedula, 'Bachiller');
                    }
                    
                    hideLoading();
                    
                    if (result) {
                        console.log('Diploma encontrado:', result);
                        displayDiplomaInfo(result);
                    } else {
                        console.log('Diploma no encontrado para cédula:', cedula);
                        showError('No se encontró ningún diploma registrado para esta cédula');
                    }
                } catch (error) {
                    console.error('Error en la búsqueda:', error);
                    hideLoading();
                    showError('Error de conexión. Por favor intente de nuevo más tarde.');
                }
            }
            
            // Función para buscar directamente en CSV
            function searchDirectInCSV(csvText, targetId, tipo) {
                const lines = csvText.split('\n');
                const normalizedTarget = targetId.toString().replace(/[^0-9]/g, '');
                console.log('Buscando ID normalizado:', normalizedTarget, 'en', tipo);
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    if (line.includes(normalizedTarget)) {
                        console.log('Línea encontrada:', line);
                        const cells = parseCSVLine(line);
                        
                        // Buscar la columna que contiene el documento
                        let documentColumn = -1;
                        let nameColumn = -1;
                        let dateColumn = -1;
                        let diplomaColumn = -1;
                        
                        for (let j = 0; j < cells.length; j++) {
                            const cellValue = cells[j].replace(/[^0-9]/g, '');
                            if (cellValue === normalizedTarget) {
                                documentColumn = j;
                                console.log('Documento encontrado en columna:', j);
                                
                                if (tipo === 'Técnico') {
                                    // Para técnicos: usar posiciones fijas basadas en estructura real
                                    nameColumn = 1;  // NOMBRES Y APELLIDOS
                                    dateColumn = 3;  // FECHA DE GRADO  
                                    diplomaColumn = 5; // NÚMERO DE DIPLOMA
                                    certificateColumn = 6; // CERTIFICADO RECIBIDO
                                } else {
                                    // Para bachilleres: usar posiciones corregidas
                                    nameColumn = 1;  // NOMBRES Y APELLIDOS
                                    dateColumn = 3;  // FECHA DE GRADUACIÓN
                                    diplomaColumn = 4; // CÓDIGO DE VERIFICACIÓN
                                }
                                break;
                            }
                        }
                        
                        if (documentColumn !== -1) {
                            const nombres = nameColumn !== -1 ? cells[nameColumn] : 'Nombre no disponible';
                            const fechaGrado = dateColumn !== -1 ? cells[dateColumn] : '';
                            const numeroDiploma = diplomaColumn !== -1 ? cells[diplomaColumn] : 'N/A';
                            const certificado = (tipo === 'Técnico' && certificateColumn !== -1) ? cells[certificateColumn] : null;
                            
                            console.log('Datos extraídos:', { nombres, fechaGrado, numeroDiploma, certificado });
                            
                            return {
                                nombres: nombres,
                                fechaGraduacion: formatDate(fechaGrado),
                                codigoVerificacion: numeroDiploma,
                                certificadoRecibido: certificado,
                                tipo: tipo,
                                institucion: 'Inandina',
                                ciudad: 'Villavicencio'
                            };
                        }
                    }
                }
                
                return null;
            }
            
            // Función para encontrar columna con contenido específico
            function findColumnWithContent(cells, startColumn, keywords, maxDistance) {
                for (let distance = 1; distance <= maxDistance; distance++) {
                    // Buscar hacia la izquierda
                    const leftIndex = startColumn - distance;
                    if (leftIndex >= 0 && cells[leftIndex] && cells[leftIndex].trim()) {
                        const content = cells[leftIndex].toLowerCase();
                        if (keywords.some(keyword => content.includes(keyword)) || content.length > 5) {
                            return leftIndex;
                        }
                    }
                    
                    // Buscar hacia la derecha
                    const rightIndex = startColumn + distance;
                    if (rightIndex < cells.length && cells[rightIndex] && cells[rightIndex].trim()) {
                        const content = cells[rightIndex].toLowerCase();
                        if (keywords.some(keyword => content.includes(keyword)) || content.length > 5) {
                            return rightIndex;
                        }
                    }
                }
                return -1;
            }
            
            // Función para parsear una línea CSV
            function parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim());
                return result;
            }
            
            // Función para formatear fecha
            function formatDate(dateStr) {
                if (!dateStr || dateStr.trim() === '') return 'Fecha no disponible';
                
                try {
                    // Intentar parsear diferentes formatos de fecha
                    let date;
                    if (dateStr.includes('/')) {
                        const parts = dateStr.split('/');
                        if (parts.length === 3) {
                            date = new Date(parts[2], parts[1] - 1, parts[0]);
                        }
                    } else if (dateStr.includes('-')) {
                        date = new Date(dateStr);
                    } else {
                        return dateStr; // Devolver como está si no se puede parsear
                    }
                    
                    if (date && !isNaN(date.getTime())) {
                        return date.toLocaleDateString('es-ES', {
                            day: 'numeric',
                            month: 'long',
                            year: 'numeric'
                        });
                    }
                } catch (error) {
                    console.error('Error formateando fecha:', error);
                }
                
                return dateStr; // Devolver original si hay error
            }
            
            // Función para mostrar información del diploma
            function displayDiplomaInfo(diplomaInfo) {
                const diplomaDiv = document.getElementById('diplomaInfo');
                
                // Campo de certificado solo para técnicos
                const certificateField = diplomaInfo.tipo === 'Técnico' && diplomaInfo.certificadoRecibido ? 
                    `<p><strong><i class="fas fa-award me-2"></i>Certificado Recibido:</strong><br>${diplomaInfo.certificadoRecibido}</p>` : '';
                
                diplomaDiv.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong><i class="fas fa-user me-2"></i>Estudiante:</strong><br>${diplomaInfo.nombres}</p>
                            <p><strong><i class="fas fa-calendar me-2"></i>Fecha de Graduación:</strong><br>${diplomaInfo.fechaGraduacion}</p>
                            <p><strong><i class="fas fa-certificate me-2"></i>Código de Verificación:</strong><br>${diplomaInfo.codigoVerificacion}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong><i class="fas fa-graduation-cap me-2"></i>Tipo:</strong><br>${diplomaInfo.tipo}</p>
                            ${certificateField}
                            <p><strong><i class="fas fa-university me-2"></i>Institución:</strong><br>${diplomaInfo.institucion}</p>
                            <p><strong><i class="fas fa-map-marker-alt me-2"></i>Ciudad:</strong><br>Villavicencio</p>
                        </div>
                    </div>
                `;
                showResults();
            }
            
            // Funciones de utilidad para mostrar/ocultar elementos
            function showLoading() {
                loadingDiv.style.display = 'block';
            }
            
            function hideLoading() {
                loadingDiv.style.display = 'none';
            }
            
            function showResults() {
                resultsDiv.style.display = 'block';
            }
            
            function hideResults() {
                resultsDiv.style.display = 'none';
            }
            
            function showError(message) {
                errorMessage.textContent = message;
                errorDiv.style.display = 'block';
            }
            
            function hideError() {
                errorDiv.style.display = 'none';
            }
            
            // Verificar si hay cédula en URL al cargar
            const urlParams = new URLSearchParams(window.location.search);
            const cedulaParam = urlParams.get('cedula');
            if (cedulaParam) {
                cedulaInput.value = cedulaParam;
                searchDiploma(cedulaParam);
            }
        });
    </script>
</body>
</html>
